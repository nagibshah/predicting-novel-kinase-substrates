---
title: "AnalysisNagib"
author: "Nsha9343"
date: "11/10/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Prep the dataset
## Initial load of data 

```{r}

dt.Insulin <- read.delim("datasets/InsulinPhospho.txt")
dt.Akt <- read.delim("datasets/Akt_substrates.txt", header = F)
dt.mTOR <- read.delim("datasets/mTOR_substrates.txt", header = F)

# Class column 
dt.Insulin["Kinases"] <- NA 

# map the known classes to the dataset 
dt.Insulin$Kinases[dt.Insulin$Identifier %in% dt.Akt$V1] <- "Akt" # positives
dt.Insulin$Kinases[dt.Insulin$Identifier %in% dt.mTOR$V1] <- "mTOR" # negatives

# generate a subset of the labelled data 
dt.labelled <- dt.Insulin[which(dt.Insulin$Kinases == 'Akt' | dt.Insulin$Kinases == 'mTOR'), ]

```

## Summarise the data 

```{r echo=FALSE}

head(dt.Insulin)
head(dt.labelled)

# remove the identifier column since it is just a phosphorilation site  
dt.labelled$Identifier <- NULL
dt.labelled$Kinases <- as.factor(dt.labelled$Kinases) # only two classes so set as a factor
dt.labelled$Kinases <- as.numeric(dt.labelled$Kinases) # only two classes so set as a factor
dt.labelled$Seq.Window <- as.character(dt.labelled$Seq.Window) # convert from factor to character
head(dt.labelled)
str(dt.labelled)

```

# Attempt to do a pairwise plot of the features to understand if the labelled data is separable

```{r}

#install.packages("lattice")
#install.packages("ggplot2")
library(lattice)
library(ggplot2)

filteredFeatures <- c("Avg.Fold","AUC","Ins.1","Ins.2","LY","MK","Kinases")
temporalFeatures <- c("X15s","X30s","X1m","X2m","X5m","X10m","X20m","X60m","Kinases")

```

## try plotting the temporal data 
```{r}
pairs(Kinases~., dt.labelled[,temporalFeatures], col=dt.labelled[,temporalFeatures]$Kinases)
```
## try plotting the other features 
```{r}
# pair-wise scatterplots colored by class
pairs(Kinases~., dt.labelled[,filteredFeatures], col=dt.labelled[,filteredFeatures]$Kinases)
```
### appears to indicate that the labeled data can be separated. Thinking SVM should work.

## find a pattern in the sequence window 
```{r}

dt.labelled.mTOR <-  dt.Insulin[which(dt.Insulin$Kinases == 'mTOR'), ]
dt.labelled.Akt <- dt.Insulin[which(dt.Insulin$Kinases == 'Akt'), ]
dt.unlabelled <- dt.Insulin[which(is.na(dt.Insulin$Kinases)), ]
dt.unlabelled$Seq.Window <- as.character(dt.unlabelled$Seq.Window)

# 7th Position is the phospho site
# total of 13 amino acids in the sequence window

phosphoSites.Akt.allSequences <- substr(dt.labelled.Akt$Seq.Window, 1,13)
phosphoSites.mTOR.allSequences <- substr(dt.labelled.mTOR$Seq.Window, 1,13)

```

```{r}

## try http:// if https:// URLs are not supported
#source("https://bioconductor.org/biocLite.R")
#biocLite("Biostrings")

# akt sequences
aktSequences <-  t(data.frame(strsplit(phosphoSites.Akt.allSequences, "")))
colnames(aktSequences) <- paste("", 1:13, sep = "")

# mtor sequences
mTORSequences <-  t(data.frame(strsplit(phosphoSites.mTOR.allSequences, "")))
colnames(mTORSequences) <- paste("", 1:13, sep = "")

# generate the consensus Matrix 
library(Biostrings)

aktSequences.pfm <- consensusMatrix(phosphoSites.Akt.allSequences, as.prob = T)
colnames(aktSequences.pfm) <- colnames(aktSequences)

mTORSequences.pfm <- consensusMatrix(phosphoSites.mTOR.allSequences, as.prob = T) #as.prob = TRUE
colnames(mTORSequences.pfm) <- colnames(mTORSequences)

```

## visualise the patterns

```{r}
library(RColorBrewer)

par(mfrow=c(1, 1), mar=c(3, 3, 3, 3) + 0.1)
barplot(aktSequences.pfm, col=brewer.pal(nrow(aktSequences.pfm), "Paired"),
            legend.text = rownames(aktSequences.pfm),
            args.legend=list(x=ncol(aktSequences.pfm) + 5,y=max(colSums(aktSequences.pfm))+4,bty = "n"),
            main="Akt Sequence Window patterns")

```

```{r}
par(mfrow=c(1, 1), mar=c(3, 3, 3, 3) + 0.1)
barplot(mTORSequences.pfm, col=brewer.pal(nrow(mTORSequences.pfm), "Paired"),
            legend.text = rownames(mTORSequences.pfm),
            args.legend=list(x=ncol(mTORSequences.pfm)+5,y=max(colSums(mTORSequences.pfm))+4,bty = "n"),
            main="mTOR Sequence Window patterns")
```

# Pattern match score
* Basic Formula  
  + With the probabbility matrix (PSSM) it is possible to calculate a total score for a specific sequence
  + The higher the score is, the higher is the probability that the sequence contains the searched motif.
  + Convert the sequence window in the unlabelled dataset to a sum based on the Position-specific Scoring Matrix (PSSM)

```{r}

#install if necessary
#source("http://bioconductor.org/biocLite.R")
#biocLite("seqLogo")
 
library(seqLogo)

#create position weight matrix
#mef2 <- apply(dftest, 1, proportion)
#mef2 <- makePWM(mef2)
#seqLogo(aktSequences.pfm)

# motif calculations function 
getMatchScore <- function(seq, PSSM) {
  x <- strsplit(x=seq,split='')
  #x
  #initialise vector to keep scores
  seq_score <- vector()
  #get the corresponding values from the PSSM
  for (i in 1:nchar(seq)){
    if (x[[1]][i] != "_") {
      seq_score[i] <- PSSM[x[[1]][i],i]
    }
    else seq_score[i] = 0.00
  }
  #seq_score
  sum(seq_score)
   
  #max score
  #sum(apply(mm,2,max))
  
}

dt.unlabelled$aktMotif <- lapply(dt.unlabelled$Seq.Window, getMatchScore, PSSM=aktSequences.pfm)
dt.unlabelled$mTORMotif <- lapply(dt.unlabelled$Seq.Window, getMatchScore, PSSM=mTORSequences.pfm)

```

# summary of the new features

```{r}

head(dt.unlabelled)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
